#include <stdbool.h>
#include <stdint.h>
#include <stdio.h>
#include <string.h>

#include <xz.h>
#include <FreeRTOS.h>

// "hello, world!\n" repeated 16 times
static const unsigned char test_input_txt[] = {
  0x68, 0x65, 0x6c, 0x6c, 0x6f, 0x2c, 0x20, 0x77, 0x6f, 0x72, 0x6c, 0x64,
  0x21, 0x0a, 0x68, 0x65, 0x6c, 0x6c, 0x6f, 0x2c, 0x20, 0x77, 0x6f, 0x72,
  0x6c, 0x64, 0x21, 0x0a, 0x68, 0x65, 0x6c, 0x6c, 0x6f, 0x2c, 0x20, 0x77,
  0x6f, 0x72, 0x6c, 0x64, 0x21, 0x0a, 0x68, 0x65, 0x6c, 0x6c, 0x6f, 0x2c,
  0x20, 0x77, 0x6f, 0x72, 0x6c, 0x64, 0x21, 0x0a, 0x68, 0x65, 0x6c, 0x6c,
  0x6f, 0x2c, 0x20, 0x77, 0x6f, 0x72, 0x6c, 0x64, 0x21, 0x0a, 0x68, 0x65,
  0x6c, 0x6c, 0x6f, 0x2c, 0x20, 0x77, 0x6f, 0x72, 0x6c, 0x64, 0x21, 0x0a,
  0x68, 0x65, 0x6c, 0x6c, 0x6f, 0x2c, 0x20, 0x77, 0x6f, 0x72, 0x6c, 0x64,
  0x21, 0x0a, 0x68, 0x65, 0x6c, 0x6c, 0x6f, 0x2c, 0x20, 0x77, 0x6f, 0x72,
  0x6c, 0x64, 0x21, 0x0a, 0x68, 0x65, 0x6c, 0x6c, 0x6f, 0x2c, 0x20, 0x77,
  0x6f, 0x72, 0x6c, 0x64, 0x21, 0x0a, 0x68, 0x65, 0x6c, 0x6c, 0x6f, 0x2c,
  0x20, 0x77, 0x6f, 0x72, 0x6c, 0x64, 0x21, 0x0a, 0x68, 0x65, 0x6c, 0x6c,
  0x6f, 0x2c, 0x20, 0x77, 0x6f, 0x72, 0x6c, 0x64, 0x21, 0x0a, 0x68, 0x65,
  0x6c, 0x6c, 0x6f, 0x2c, 0x20, 0x77, 0x6f, 0x72, 0x6c, 0x64, 0x21, 0x0a,
  0x68, 0x65, 0x6c, 0x6c, 0x6f, 0x2c, 0x20, 0x77, 0x6f, 0x72, 0x6c, 0x64,
  0x21, 0x0a, 0x68, 0x65, 0x6c, 0x6c, 0x6f, 0x2c, 0x20, 0x77, 0x6f, 0x72,
  0x6c, 0x64, 0x21, 0x0a, 0x68, 0x65, 0x6c, 0x6c, 0x6f, 0x2c, 0x20, 0x77,
  0x6f, 0x72, 0x6c, 0x64, 0x21, 0x0a, 0x68, 0x65, 0x6c, 0x6c, 0x6f, 0x2c,
  0x20, 0x77, 0x6f, 0x72, 0x6c, 0x64, 0x21, 0x0a
};
static const unsigned int test_input_txt_len = 224;

static const unsigned char test_input_txt_xz[] = {
  0xfd, 0x37, 0x7a, 0x58, 0x5a, 0x00, 0x00, 0x01, 0x69, 0x22, 0xde, 0x36,
  0x02, 0x00, 0x21, 0x01, 0x06, 0x00, 0x00, 0x00, 0xeb, 0x78, 0xfc, 0xf3,
  0xe0, 0x00, 0xdf, 0x00, 0x15, 0x5d, 0x00, 0x34, 0x19, 0x49, 0xee, 0x8d,
  0xef, 0x8c, 0x6b, 0xca, 0x95, 0x59, 0x10, 0x04, 0xb0, 0x28, 0x91, 0xea,
  0xfc, 0x84, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x38, 0x33, 0xfc, 0xd8,
  0x00, 0x01, 0x2d, 0xe0, 0x01, 0x00, 0x00, 0x00, 0x8f, 0x62, 0x0f, 0xe8,
  0x3e, 0x30, 0x0d, 0x8b, 0x02, 0x00, 0x00, 0x00, 0x00, 0x01, 0x59, 0x5a
};
static const unsigned int test_input_txt_xz_len = 84;

#define BUF_SIZE (2 * 1024)

static bool unxz_test_case1(void)
{
    bool ret = false;
    uint8_t *out_buf = NULL;
    struct xz_buf b;
    struct xz_dec *s;
    enum xz_ret xzret;

	xz_crc32_init();

    if (!(out_buf = pvPortMalloc(BUF_SIZE))) {
        printf("buffer create failed\r\n");
        goto exit;
    }

    if (!(s = xz_dec_init(XZ_SINGLE, 0))) {
        printf("xz init failed\r\n");
        goto exit;
    }

    b.in = test_input_txt_xz;
    b.in_pos = 0;
    b.in_size = test_input_txt_xz_len;

    b.out = out_buf;
    b.out_pos = 0;
    b.out_size = BUF_SIZE;

    xzret = xz_dec_run(s, &b);
    xz_dec_end(s);
    if (xzret != XZ_STREAM_END) {
        printf("decoding failed, ret %d\r\n", xzret);
        goto exit;
    }

    if (b.out_pos != test_input_txt_len) {
        printf("decoded data length mismatch\r\n");
        goto exit;
    }
    if (memcmp(out_buf, test_input_txt, test_input_txt_len)) {
        printf("decoded data mismatch\r\n");
        goto exit;
    }
    ret = true; // passed
exit:
    vPortFree(out_buf);
    return ret;
}

void unxz_test_suite(void)
{
    printf("case1 ");
    if (unxz_test_case1()) {
        printf("passed\r\n");
    } else {
        printf("failed\r\n");
    }
}
